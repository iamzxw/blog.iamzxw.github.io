---
layout:     post   				    # 使用的布局（不需要改）
title:     	OPPO TOP高校创新科技大赛 / 人像精细分割方案
subtitle:   方案没有通过评审....   #副标题
date:       2018-10-17 				# 时间
author:     zhu.xinwei 		    	# 作者
header-img: img/post-bg-desk.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - 人像精细分割
    - Mask-RCNN
    - Supervise.ly
---

____
## 1 赛题重述

随着手机硬件平台和人工智能技术的飞速发展，目前的智能手机基本都可以实现后置双摄像头和前置单摄像头对人像拍照时的背景虚化。在虚化的方法上，后置通过双摄像头来计算景深从而实现前景人像的分割，进而对背景虚化；而前置则直接对单帧图像进行人像分割的方式来虚化背景。这两种方式来带的虚化效果是显著的，但是也存在很多弊端，无论哪种分割方式，都难以实现对人像发丝的精细分割，这导致了最终人像头部边缘的虚化效果不是很理想。随着用户对手机相机拍照功能要求的逐年升级，为了达到单反相机级别的背景虚化效果，需要能够实现人像的精细分割，尤其是发丝边缘。这样不仅可以实现更加精确的背景虚化，同时也为人像照片换背景提供了技术支持，而这些可以进一步增强用户的使用体验。
- 输入：RGB 人像图片
- 输出：分割为人像和背景的图片 

____
## 2 赛题分析

图像分割的难度在于要先对一张图片所有的目标进行正确的检测同时还要对每个示例进行分割。目标检测的目的是把每一个单个目标分类然后用bounding box标定出来，而人像精细分割的目的是区分每一个像素是否属于人像，而进行像素 级精细的分割。人像分割(Portrait Segmentation)属于计算机视觉中语义分割(Semantic Segmentation)的一种精细化应用。目前现有的语义分割模型有许多种。从早期的Fully Convolutional Networks (2014)、SegNet(2015)、U-Net(2015) 到最近两年出现的DeepLab v3+、Mask_RCNN、PSPNet等模型，语义分割的精准度在快速提升。人像分割的常见方法是先对物体进行检测，然后用边界框对画中物体进行分割。但是大多数研究都没有注意到人类的特殊性，立足于多种类别的目标检测与实例分割，缺乏对人像精细分割的针对性。
通过基于Mask R-CNN，我们队伍将创新并应用一些针对人像分割任务的方法，包括：对于数据集的优化方法，通过身体姿势进行人像分割优化，通过多模型融合等。通过部署目前图像分割领域得最前沿算法，利用已知的多种类型的人像数据集，融合各网络得优势，完成赛题，实现对人像得精细分割。

## 3 算法方案摘要
- 本项目拟基于Mask_RCNN模型，https://arxiv.org/abs/1703.06870 。
- 针对COCO、Pascal、Mapillary等公开数据集人像标注数据质量粗糙问题，我们使用最新发布在Supervise.ly平台上的专用人像精细分割数据集。
- 针对训练数据与线上测试数据（或实际应用场景数据）分布不一致问题，我们计划从智能手机社区(如，OPPO手机社区)收集带有人像的拍摄照片，并利用Supervise.ly平台或者其他高效的图像标记工具，构建自己的人像精细分割数据集。
- 针对人像发丝分割问题，首先，我们使用专用于发丝语义分割的数据集Figaro进行模型训练。其次，从光谱分割(spectral segmentation) 角度来解决发丝软分割问题，既考虑了图片的纹理和颜色特征，也利用了由深度神经网络生成的更高层的语义信息。
- 主要创新点
- 使用最新发布的专用于人像精细分割数据集(Supervise.ly)和精细发丝分割数据集(Figaro)。
- 针对人像发丝分割问题，我们从光谱分割(spectral segmentation) 角度来解决发丝软分割问题，既考虑了图片的纹理和颜色特征，也利用了由深度神经网络生成的更高层的语义信息。
- 最终提交形式： 可运行的人像分割模型源代码， 使用python语言完成，需要keras、pytorch、GPU等环境。


## 4 实施方案
本方案基于Mask_RCNN并加入创新点实现方案基本架构，面向人像数据集做出针对性调整和创新。方案基本架构如下：


首先，数据集方案我们除了使用COCO数据集外，加入了最新公开的精细人像数据集和精细发丝分割数据集：Supervise.ly(2018)、Figaro 1K(2017)等。此外，为了保持模型的训练数据与线上测试数据具有一致性，我们将计划收集来源于OPPO手机或其他手机端的人像的拍摄照片，利用Supervise.ly平台或者其他高效的标注工具，自行构建一些人像分割数据集。 

算法方案总体框图采用Mask_RCNN主线流程，Mask_RCNN网络将像素级分割并入了FasterR-CNN中，不过区别于全卷积类型的网络，Mask_RCNN仍保持R-CNN各任务高度解耦和的风格。此外，为了实现准确的分割，Mask_RCNN还改进了兴趣区域池化层，主要很大程度解决了对不准的问题（RoIAlign）。提出了RoIAlign以优化RoIPool带来的空间位置错位问题。RoIAlign解决了RoIPool找到卷积产生的特征图对应位置提取特征小块取整导致对不齐的问题，而是通过双线性插值确定原图兴趣区域中每个点的特征值，再进行池化等操作就相对准确。

此外，Mask_RCNN应用了FPN特征金字塔网络的技术，实现了不同尺度特征的更有效利用，在单一尺度输入的情况下，很好的解决了多尺度问题。FPN采用了自上而下的侧向连接将不同尺度的特征连接融合（上采样后相加）起来，再进行3x3的卷积以消除混叠现象，而后在所有尺度上进行预测，重复这个过程，直到得到最佳的分辨率。FPN在不增加计算量的前提下，很好的解决了多尺度下小物体的精准快速检测问题。

基于以上Mask_RCNN方案，使用一个对准模块（Affine Align），基于人体姿势检测结果，将感兴趣区域（ROI）对齐为统一大小。同时，为图中的每个人物生成骨架特征，并将它们连接到ROI。将骨骼信息明确地添加到网络中为图像分割提供更好的信息。

此外加入基于 deeplab_resnet 实现的特征提取，从光谱分割角度来解决精细发丝分割问题，提出的图结构(Graph Structure)，既考虑了图片的纹理和颜色特征，也利用了由深度神经网络生成的更高层的语义信息，根据该方法自动完成人像分割。

____
## 5 目前工作展示

针对COCO、Pascal、Mapillary等公开数据集人像标注数据质量粗糙问题，我们使用最新发布在Supervise.ly平台上人像分割数据集。

左图为来自COCO数据集的标注示例，右图为来自Supervise.ly人像数据集的标注示例。可以看出COCO数据集在人像轮廓边缘的标注相当粗糙。监督学习的最终效果，很大一部分取决于人工标注数据集的质量。所以COCO等语义分割公开数据集的标注，不满足我们的要求。另外，现有的语义分割公开数据集都是针对多个类别的标注，如，COCO数据集中有80个类别。所以我们采用最新(2018)发布在Supervise.ly平台上的专用于人像分割的精细化数据集。
下面是我们处理后的Supervise.ly数据集目录说明
Supervise.ly Person Dataset Directory
- portrait
- train
- ann: 5130个标注文件
- img: 5130张图片
- val 
- ann: 580个标注文件
 img: 580张图片

注：原Supervise.ly Person Dataset数据集中有5711张图片，其中一个标注数据(bodybuilder-weight-training-stress-38630.json)为空, 剔除后正好对应 5710张图片，随机选取10%(580张图片)作为训练验证集。百度云下载地址：https://pan.baidu.com/s/1DVOBTE_OjcNMceJInRMUjA 由于百度云上传限制4G文件，所以将portrait_all/train/img文件夹中的图片，分出来三份: portrait_all.zip、img_1.zip、img_2.zip、img_3.zip。先解压portrait_all.zip, 然后将img_1.zip, img_2.zip, img_3.zip中的图片，解压到portrait_all/train/img文件夹下，即可。

目前已完成图像分割Baseline代码，后期将在此基础上进创新和跟进，实现上述方案中模型的集成，达到人像精细分割效果。

注: Baseline代码见：https://github.com/iamzxw/OPPO_Portrait_Segmentation

Baseline可视化展示：
- 显示候选区域的排序及其与候选框提取成正、负相关性：
- 边界框的优化(虚线代表目标检测结果，实现代表优化后的结果):
- 生成人像的Mask（然后进行缩放并在图像中定位）：
- 激活层显示（用于分析错误原因）
- 权重直方图


## 6 比赛时间规划
- 2018.12.20 - 2019.01.20 数据集准备，数据预处理，构建Baseline模型
- 2019.01.21 - 2018.02.20 尝试不同模型，结果分析，做具体优化
- 2019.02.21 – 2019.03.15 根据作品提交结果，进一步完善复赛算法，优化实现效果


### 官方回复

亲爱的Voyagers队的同学： 
你们好，我是此次OPPO AI创新大赛人像精细分割部分的负责人，对你们队伍没有入围感到很遗憾，此次OPPO AI创新大赛人像精细分割的比赛吸引了全国范围内的近百个团体报名参赛，最终筛选出18个团队进入复赛，竞争十分激烈。在筛选过程中，我们综合多方面进行了两次筛选，第一次筛选得出了30支队伍，你们的队伍位列其中，在第二轮筛选中，我们综合考虑了选手过往的科研经历和比赛成绩，更青睐于那些在TPAMI、CVPR、NIPS、AAAI、IJCAI等顶级会议和期刊上发表论文的团队，以及在过往分割方向国内和国际竞赛取得良好成绩的队伍。 我仔细阅读过你们的项目计划书，项目计划书中给了相应的网络结构以及数据集描述，基于Mask R-CNN是大多数团队的思路，你们同时也提到了使用Supervise.ly和Figaro数据集，以及提出了光谱分割的概念，这是比较新颖的一个思路，整体来看团队的项目计划书有一个较高的水平，但是在最后筛选时，由于团队数较多而入围数较少，竞争非常激烈，很遗憾你们团队最终没有入围。